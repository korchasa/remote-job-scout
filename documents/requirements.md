# Спецификация требований к программному обеспечению

## Обзор системы

Веб-приложение для поиска удалённой работы с анализом на основе ИИ. Среда выполнения Node.js, бэкенд на Express.js, модульная архитектура.

## Функциональные требования

### FR-1: Настройки

- Описание: Предоставление настраиваемых пользовательских настроек поиска, сохраняемых на стороне клиента и отправляемых на сервер одним запросом.
- Сценарий использования: Пользователь настраивает список должностей, источники, фильтры языка и стран. После перезагрузки страницы настройки восстанавливаются из localStorage. При запуске поиска полная конфигурация отправляется единожды в теле запроса.
- Критерии приёмки:
  - Настройки включают список должностей, элементы чёрного списка и выбранные источники.
  - Поддерживаются фильтры языка и страны; для стран используется массив разрешённых значений.
  - Настройки сохраняются в localStorage и автоматически восстанавливаются при загрузке приложения.
  - Запуск поиска отправляет один объединённый запрос с текущими настройками.

### FR-2: Поиск в несколько этапов

- Описание: Выполнение конвейера из 3 этапов (Сбор → Фильтрация → Обогащение) с прогрессом по HTTP polling, возможностью приостановки/возобновления и статистикой по этапам.
- Сценарий использования: Пользователь запускает поиск из UI, наблюдает обновления прогресса через периодические опросы, приостанавливает процесс на этапе сбора, позже возобновляет и по завершении просматривает статистику по каждому этапу. При запуске нового поиска клиент очищает предыдущие результаты до прихода новых данных.
- Критерии приёмки:
  - Конвейер состоит из трёх этапов с явными переходами и статусами (pending, running, completed, failed, stopped, paused, skipped).
  - Прогресс доступен через REST API с HTTP polling и отображается в UI в реальном времени.
  - Действия Pause/Resume меняют состояние текущего этапа без потери уже полученных данных.
  - Действие Stop/пауза сохраняет результаты, собранные к моменту остановки.
  - Новый запуск поиска очищает прежние результаты на клиенте перед началом новой сессии.
  - Статистика включает разбивку по этапам, в т.ч. результаты фильтрации и метрики обогащения (см. FR-4/FR-5).

### FR-3: Сбор (этап 1)

- Описание: Сбор вакансий из нескольких источников с параллельной обработкой, экспоненциальным backoff при ошибках и сериализацией в YAML, с регулярными обновлениями промежуточного прогресса.
- Сценарий использования: Пользователь включает источники Indeed, LinkedIn и OpenAI WebSearch. Система выполняет запросы параллельно с ограничением по степени параллелизма, повторяет попытки при временных сбоях (429/403/сети) по экспоненциальной схеме, пишет YAML-дампы и выдаёт обновления прогресса.
- Критерии приёмки:
  - Источники: Indeed GraphQL, LinkedIn, OpenAI WebSearch.
  - Параллельная обработка с параметризуемым пределом параллелизма.
  - Повторные попытки по схеме экспоненциального backoff с логированием причин сбоев.
  - Промежуточный прогресс доступен и отображается в UI во время выполнения.
  - Собранные вакансии сериализуются в YAML в процессе работы.

### FR-4: Фильтрация (этап 2)

- Описание: Автоматическая фильтрация собранных вакансий по пользовательским правилам (включая чёрный список и whitelist стран) с предоставлением детализированной статистики причин пропуска.
- Сценарий использования: После завершения сбора система автоматически запускает фильтрацию в рамках сессии, проверяет вакансии на соответствие настройкам (чёрный список компаний, ключевые слова, язык, whitelist стран) и формирует счётчики прошедших/отклонённых с разбивкой по причинам.
- Критерии приёмки:
  - Фильтрация запускается автоматически после завершения сбора для текущей сессии.
  - Применяются актуальные пользовательские настройки: чёрный список, правила по заголовкам/языку, whitelist стран (массив строк).
  - Для этапа генерируются статусы и агрегированная статистика.
  - Доступна разбивка причин пропуска (например, title_blacklisted_words, language_requirements, country_filter, company_blacklisted).

### FR-5: Обогащение с помощью LLM (этап 3)

- Описание: Обогащение вакансий с использованием OpenAI, включая исследование компаний через веб-поиск, трекинг токенов/стоимости и источников обогащения, с корректной обработкой отсутствующих данных.
- Сценарий использования: Пользователь вводит API-ключ OpenAI на клиенте. Во время обогащения интерфейс отображает расход токенов и оценочную стоимость; при недоступности источников/ошибках обогащение для конкретной вакансии помечается как неудачное без остановки конвейера.
- Критерии приёмки:
  - Интеграция с OpenAI выполняет текстовое обогащение и может использовать веб-поиск для исследования компаний.
  - Отслеживаются токены и стоимость на вакансию; агрегаты отображаются в панели прогресса.
  - Фиксируется источник(и) обогащения для вакансии.
  - При отсутствии данных/ошибках выполняется корректное понижение функциональности с понятными сообщениями.
  - Промежуточные результаты обновляются для UI в ходе этапа.

### FR-6: Управление вакансиями

- Описание: Современный адаптивный интерфейс для просмотра и управления вакансиями: карточки, детали, переходы на внешние ссылки, базовое управление чёрным списком, темы.
- Сценарий использования: Пользователь просматривает список карточек, открывает модальное окно с деталями, переходит по внешней ссылке на оригинальное объявление, управляет чёрным списком через доступные действия. Интерфейс корректно работает на мобильных и десктопах, поддерживает светлую/тёмную темы.
- Критерии приёмки:
  - Доступны список вакансий и модальное окно с деталями с плавной навигацией.
  - Внешние ссылки открываются в новой вкладке с безопасными атрибутами.
  - Базовые операции управления чёрным списком доступны в UI; серверные изменения выполняются через соответствующие API (если применимо на текущем этапе).
  - Интерфейс адаптивен, поддерживает переключение тем; выбор темы сохраняется.
  - Исключается избыточный трафик за счёт оптимизированного взаимодействия клиент-сервер.

### FR-7: Избранное

- Описание: Интерфейс для сохранения и просмотра избранных вакансий с заменой действия «Отложить» на «Добавить в избранное» и локальной персистентностью пользовательских пометок.
- Сценарий использования: Пользователь отмечает вакансию как избранную, просматривает список избранных на отдельном экране, при этом действия скрытия/блокировки сохраняются локально и применяются при отображении.
- Критерии приёмки:
  - Действие «Отложить» заменено на «Добавить в избранное» в карточке и в модальном окне.
  - Существует отдельный экран/вкладка «Избранное» со списком сохранённых вакансий.
  - Избранные вакансии и состояния скрытия/блокировки персистируются локально (localStorage) и применяются при рендеринге.
  - Действия скрытия/блокировки не инициируют PATCH-запросы на сервер; взаимодействие с сервером ограничено данными, управляемыми сервером.

### FR-8: Сохранение и восстановление снимков сессии

- Описание: Сервер должен сохранять снимки сессий поиска (прогресс и результаты) в файловую систему и восстанавливать их при запуске.
- Сценарий использования: Пользователь запускает многоэтапный поиск; сервер неожиданно перезапускается; после перезапуска пользователь видит сессию с соответствующей меткой (завершена/приостановлена/остановлена) и может возобновить или просмотреть результаты.
- Критерии приёмки:
  - Снимки записываются в `data/sessions/<sessionId>.json` во время обработки и при переходе между этапами.
  - При запуске сервера ранее завершённые сессии доступны для просмотра только для чтения; сессии в процессе восстанавливаются как остановленные/приостановленные без потери данных.
  - После восстановления не происходит дублирования обработки; возобновление продолжается с правильных границ этапов.

### FR-9: Расчёт и отображение ETA

- Описание: Система должна вычислять и отображать оценку оставшегося времени (ETA) для каждого этапа на основе скорости обработки и оставшегося объёма работы.
- Сценарий использования: Во время сбора из нескольких источников пользователь видит на панели мониторинга процент выполнения и ETA, который обновляется со временем.
- Критерии приёмки:
  - ETA рассчитывается по формуле `(всего - обработано) / скорость × 60` (в минутах) с сглаживанием для уменьшения скачков.
  - ETA и процент выполнения доступны через API и отображаются в интерфейсе прогресса.
  - Когда работа завершается, ETA становится 0, и этап немедленно переходит к следующему.

### FR-10: Навигация с клавиатуры

- Описание: Предоставление сочетаний клавиш для навигации по списку вакансий и открытия/закрытия деталей вакансии.
- Сценарий использования: Пользователь просматривает результаты поиска с помощью клавиш стрелок вверх/вниз для перемещения выделения, нажимает Enter для открытия деталей и Esc для закрытия.
- Критерии приёмки:
  - Стрелки вверх/вниз изменяют выделенный элемент списка без проблем с прокруткой.
  - Enter открывает модальное окно с деталями выбранной вакансии; Esc закрывает его.
  - Сочетания клавиш не мешают вводу текста (отключаются при наборе текста).

### FR-11: Сохранение действий на стороне клиента (скрытие/блокировка)

- Описание: Скрытие вакансий и блокировка работодателей хранятся и применяются только на клиенте и не отправляются на сервер.
- Сценарий использования: Пользователь скрывает вакансию и блокирует компанию; после перезагрузки страницы эти действия сохраняются через localStorage, а сервер не изменяется.
- Критерии приёмки:
  - localStorage хранит списки скрытых идентификаторов вакансий и заблокированных названий компаний.
  - Скрытые и заблокированные элементы фильтруются в интерфейсе и в клиентской логике фильтрации.
  - На действия скрытия/блокировки не выполняется PATCH-запросов на сервер; в сетевых логах отсутствие таких вызовов подтверждается.

### FR-12: Валидация ввода на основе схем и ответы об ошибках

- Описание: Все серверные конечные точки должны проверять входные данные по схемам и возвращать стандартизированные ответы об ошибках при неудачной валидации.
- Сценарий использования: Отправляется некорректный запрос поиска; сервер отвечает ошибкой 400 с машинно-читаемым отчётом о валидации.
- Критерии приёмки:
  - Запросы к конечным точкам поиска, действий с вакансиями и настроек проверяются по схемам.
  - При неудаче ответы содержат HTTP 400 с `{ code, message, details }`, где `details` перечисляет ошибки по полям.
  - Корректные запросы передаются в бизнес-логику; некорректные не изменяют состояние.

### FR-13: Операционное логирование и аудит

- Описание: Система должна записывать структурированные логи для действий пользователя, переходов между этапами, повторных попыток и ошибок с маскировкой конфиденциальных данных.
- Сценарий использования: Оператор просматривает логи для анализа неудачного обогащения; в логах отображаются попытки, интервалы задержки и замаскированные API-ключи.
- Критерии приёмки:
  - Логи включают временные метки, идентификаторы сессий, названия этапов, количество попыток и краткие описания ошибок.
  - Секреты (например, ключи OpenAI) никогда не записываются в логи; маскировка проверяется в тестах.
  - Логи доступны во время разработки через консоль и могут направляться в файлы в Docker.

### FR-14: Обработка API-ключа OpenAI (только на клиенте)

- Описание: API-ключ OpenAI хранится только на клиенте, передаётся с запросами обогащения при необходимости и никогда не сохраняется и не логируется на сервере.
- Сценарий использования: Пользователь вводит API-ключ в интерфейсе; запускается обогащение; перезапуск сервера не сохраняет ключ; в логах сервера ключ не отображается.
- Критерии приёмки:
  - Ключ хранится в localStorage на клиенте и исключён из серверных слоёв хранения.
  - Сервер получает ключ только как часть операций обогащения и не записывает его на диск или в логи.
  - Обогащение работает с валидным ключом и корректно завершается с понятными сообщениями при отсутствии или неверности ключа.

## Нефункциональные требования

### Производительность

- Отклик интерфейса < 1 с
- Обработка 100 вакансий < 10 мин
- Параллельная обработка запросов

### Надёжность

- Корректная обработка недоступности API
- Восстановление после сбоев
- Комплексное логирование

### Безопасность

- Валидация ввода на всех уровнях
- Защита от SQL-инъекций
- API-ключ OpenAI только на стороне клиента

### Удобство использования

- Интуитивный интерфейс
- Адаптивный дизайн
- Светлая/тёмная темы
- Навигация с клавиатуры

## Технические спецификации

### API и интеграции

- OpenAI API для обработки с помощью LLM
- OpenAI WebSearch для глобального поиска
- Парсинг вакансий: Indeed GraphQL, LinkedIn
- Архитектура JobSpy в качестве ориентира

### Форматы данных

- Взаимодействие через REST API
- Обмен данными в формате JSON
- Сериализация вакансий в YAML
- Опрос прогресса через HTTP
- Middleware Express.js

### Сохранение сессий

- Клиент: localStorage
- Сервер: файловая система

### UI/UX

- Современный адаптивный интерфейс
- Компоненты Shadcn/ui
- Соответствие требованиям доступности
- Дизайн с приоритетом мобильных устройств
- Отслеживание прогресса в реальном времени

## Текущая реализация

- Сервер на Node.js + Express.js
- Фронтенд на React/TypeScript + Vite
- Поисковой конвейер из 3 этапов с возможностью приостановки/возобновления
- 3 парсера: Indeed, LinkedIn, OpenAI с повторными попытками и задержкой
- Интерфейс вакансий с Shadcn/ui, статистика фильтрации
- Многоэтапная сборка в Docker
- Интеграция API, отслеживание токенов и стоимости
- Строгий режим TypeScript
- Тестирование с Vitest
- Контроль качества кода с ESLint/Prettier
- Рабочий процесс CLI
- Сериализация в YAML, сохранение сессий
