### Goal

- Реализовать требования из `documents/requirements.md` с учетом текущей архитектуры, закрыть пробелы и обеспечить проверяемые критерии готовности.

### Progress

### Overview

- Текущее состояние:
  - Бэкенд: Express.js, маршруты `jobs`, `search`, `multi-stage`; оркестратор многостадийного поиска; скрапперы Indeed (GraphQL), LinkedIn, OpenAI WebSearch; фильтрация и обогащение; хранилище в памяти.
  - Фронтенд: React 19 + shadcn/ui, конфигурация поиска с localStorage, прогресс по HTTP polling, список вакансий с действиями Skip/Defer/Blacklist, нет экрана Избранного.
  - Dev: унифицированный `./run check` (build, format, lint, scan, tests), Docker multi-stage.
- Проблемы/пробелы относительно требований:
  - ✅ FR-5: OpenAI обогащение с учетом токенов/стоимости, трекингом источников; ключ хранится только на клиенте; обработка пропусков мягкая.
  - ✅ Исправлена ошибка AVAILABLE_SOURCES на клиенте - константа перемещена из shared/schema.ts в клиентский компонент SearchConfigPanel.tsx.
  - ✅ Добавлено монтирование папки ./var/ для хранения данных приложения (сессии, YAML дампы вакансий).
  - ✅ Добавлено поле ввода OpenAI API ключа в интерфейс SearchConfigPanel с корректной передачей на сервер.
  - ✅ **НОВАЯ АРХИТЕКТУРА**: Переделана структура SearchRequest - унифицированные sources, глобальный API ключ, валидация на фронтенде, исправлены все тесты.
  - ✅ **УДАЛЕНЫ ФИЛЬТРЫ ВРЕМЕНИ**: Полностью удалены рабочие дни и рабочие часы из фильтров.
  - ✅ **ОБНОВЛЕНЫ ФИЛЬТРЫ СТРАН**: Изменен формат фильтров стран с blacklist/whitelist объектов на простой массив строк (whitelist). Клиент теперь отправляет полный список разрешенных стран.
  - FR-6: современный UI есть; внешние ссылки есть; «управление черным списком» частично (через PATCH к серверу).
  - FR-7: нет «Избранного» и замены Snooze→Favorites; «Скрыть/Заблокировать» не сохраняются в локальных настройках, а шлются на сервер.
  - NFR: параллельная обработка минимальна; нет явного backoff; валидация входных данных ограничена; клавиатурная навигация отсутствует.
  - Tech Specs: файловая персистентность сессий отсутствует; Zod-валидация не интегрирована на всех входах.
- Плюсы текущей базы: модульная архитектура, готовые скрапперы/оркестратор/роуты, UI и polling уже работают, единый проектный чек.
- Минусы: функциональные пробелы FR-5/FR-7/персистентность; безопасность и валидация требуют усиления; производительность/устойчивость без retry/параллелизма ограничены.

### Definition of Done (DoD)

- FR-5: Обогащение LLM:
  - Ключ OpenAI хранится на клиенте (в localStorage) и передается на сервер для обогащения вакансий; на сервере не сохраняется в постоянном хранилище.
  - Ведется учет токенов и стоимости; UI показывает стоимость и скорость.
  - Трекинг источников (enrichment.sources) и мягкая обработка пропусков.
- FR-6: UI управления вакансиями: карточки/модалки/навигация/внешние ссылки работают, адаптив и темы сохранены.
- FR-7: Избранное и действия:
  - Кнопка «Snooze» заменена на «Add to Favorites»; отдельный экран Favorites.
  - «Скрыть вакансию» и «Заблокировать работодателя» сохраняются в локальных настройках и применяются при отображении/фильтрации; без PATCH на сервер.
- NFR/Безопасность/Юзабилити:
  - Параллелизм + backoff обеспечивают сбор >=100 вакансий < 10 минут в dev-среде (best-effort, параметризуемо).
  - Валидация всех входов через Zod; graceful handling для недоступности источников.
  - Базовая клавиатурная навигация (перемещение по списку, открытие деталей).
- Техническое:
  - Сессии и прогресс сохраняются на файловую систему (`data/sessions/<sessionId>.json`) для восстановления после рестарта (dev-уровень).
  - YAML-дампы вакансий пишутся в процессе.
- Проектные проверки:
  - `./run check` проходит: build client/server, prettier, eslint без предупреждений, комментарий-скан без TODO/FIXME, vitest — все тесты зеленые.

### Solution (шаги)

1. ✅ FR-5. Обогащение: учет токенов/стоимости, источники, ключ на клиенте:
   - ✅ Убрана загрузка ключа OpenAI из `.env` в `CollectionController.startMultiStageSearch`
   - ✅ Добавлен учет токенов в `EnrichmentService.callOpenAI` с чтением `usage` из ответа API
   - ✅ Реализован расчет стоимости по тарифу GPT-3.5-turbo ($0.0015/1K input, $0.002/1K output)
   - ✅ Добавлен трекинг источников `enrichment.sources` в `Vacancy.data`
   - ✅ Обновлен `MultiStageProgress` с полями `enrichmentStats` (tokensUsed, costUsd, sourcesCount)
   - ✅ Отображены метрики токенов/источников в `ProgressDashboard`
   - ✅ Обновлена трансформация данных в `useSearchSessions.ts` для передачи enrichmentStats
2. FR-6/FR-7. Действия с вакансиями и Избранное:
   - Заменить кнопку Snooze на «Add to Favorites» в `JobCard` и `JobDetailsModal`.
   - Добавить экран Favorites (фильтрация по локальному состоянию), навигацию/вкладку.
   - Реализовать локальное хранение «скрытых вакансий» и «заблокированных работодателей» (localStorage: списки id и компаний). Применять при рендере (не отправлять PATCH).
   - Оставить PATCH только для статусов, управляемых сервером (напр., enriched), если требуется.
3. NFR. Производительность/надежность:
   - Включить конфиг ограничителя параллелизма и backoff; замерять скорость и ETA (формула из design.md). Логи/метрики.
   - Улучшить graceful handling в скрапперах (Indeed/LinkedIn/OpenAI): timeouts, ошибки сети, 429/403, повторные попытки.
4. Security/Validation:
   - Добавить Zod-схемы для `SearchRequest`, PATCH `/api/jobs/:id` и валидировать в маршрутах; централизованный обработчик ошибок.
   - Обновить README: ключ OpenAI задается в UI и хранится клиентом (риски описать), на сервер не сохраняется.
5. Tech Specs. Персистентность:
   - Запись снимков прогресса в `data/sessions/<sessionId>.json`; восстановление после рестарта (читать при старте сервера и подхватывать «завершенные/остановленные» состояния как завершенные, активные — как остановленные).
6. UX. Клавиатурная навигация:

- Минимальный набор: стрелки вверх/вниз — перемещение по списку, Enter — детали, Esc — закрыть.

7. Тесты и документы:

- Обновить существующие тесты и добавить новые: скрапперы (моки), оркестратор (pause/resume/stop), валидация, сериализация YAML, локальные действия (favorites/hide/block), прогресс нормализация.
- Обновить документы (README: ключ, инструкции; design: персистентность/параллелизм).

8. Проектный чек (финальный шаг):

- Запуск `./run check` должен пройти полностью.

### Consequences

- Плюсы:
  - Соответствие требованиям FR/NFR; улучшенная производительность и устойчивость; прозрачные метрики (стоимость/токены); локальная приватность ключа и пользовательских действий.
  - Файловые сессии облегчают отладку и повторное использование результатов.
- Минусы/риски:
  - Ключ OpenAI на клиенте — повышенный риск утечки; смягчаем предупреждением и опциональным шифрованием в localStorage.
  - LinkedIn/Indeed могут ограничивать скраппинг (429/403); backoff/лимиты снизят скорость.
  - Файловая персистентность увеличивает IO и объем проекта; следует параметризовать включение.

### Critique & Refinement

- Альтернативы:
  - Хранить OpenAI ключ на сервере (.env) безопаснее, но противоречит требованиям — оставляем клиентское хранение с явным предупреждением и отключаем логирование ключа.
- Итог: оставить перечисленные решения, параметризовать спорные места (OpenAI model и тарифы), документировать риски.

### Passed Project Checks to add in DoD

- Client/Server build без ошибок.
- Prettier форматирование пройдено.
- ESLint без предупреждений (`--max-warnings 0`).
- Отсутствуют TODO/FIXME/HACK/DEBUG-комментарии (сканер в `run.ts`).
- Vitest — все тесты зеленые.

### Final step in Solution

- ✅ Исправлена критическая ошибка AVAILABLE_SOURCES на клиенте
- ✅ Изменена логика валидации: кнопка поиска всегда доступна, но подсвечиваются поля с ошибками при нажатии
- ✅ Выполнен `./run check` - все проверки пройдены: build, format, lint, scan, tests (59 passed)
- ✅ Зафиксирован результат в whiteboard.md

## ЗАДАЧА ВЫПОЛНЕНА ✅

Кнопка поиска теперь всегда доступна, но при ее нажатии подсвечиваются поля с ошибками валидации.
