# FR-2: Multi-Stage Search Process - План Реализации

## Goal (Цель)
Реализовать многоэтапный процесс поиска вакансий с визуализацией прогресса в реальном времени, позволяющий пользователю отслеживать выполнение всех стадий и при необходимости останавливать процесс.

## Overview (Обзор)
Текущая система поддерживает только сбор вакансий (Stage 1). Необходимо расширить архитектуру для поддержки полного цикла:
1. **Stage 1**: Collection - сбор вакансий из источников ✅ (уже реализовано)
2. **Stage 2**: Filtering - предварительная фильтрация по настройкам пользователя
3. **Stage 3**: Enrichment - обогащение данных с помощью LLM
4. **Stage 4**: Completion - финализация и отображение результатов

Система должна показывать текущий этап, прогресс выполнения и позволять остановку на любом этапе.

## Definition of Done (Критерии готовности)
- [ ] ✅ Запуск многоэтапного процесса поиска
- [ ] ✅ Отображение текущего этапа и реального прогресса
- [ ] ✅ Возможность остановки поиска на любом этапе
- [ ] ✅ Сохранение результатов при остановке
- [ ] ✅ Отображение финальной статистики по завершении
- [ ] ✅ Прохождение всех unit и integration тестов
- [ ] ✅ Обновление технической документации

## Solution (Решение)
### Архитектурные изменения

1. **Расширение SearchOrchestrator**:
   - Создание `MultiStageSearchOrchestrator` для координации всех стадий
   - Добавление состояний для каждой стадии в `ProcessingStage`
   - Интеграция с существующим `CollectionController`

2. **Новые сервисы**:
   - `FilteringService` - для предварительной фильтрации вакансий
   - `EnrichmentService` - для LLM обогащения данных
   - `ProgressTracker` - для отслеживания прогресса по всем стадиям

3. **Расширение API**:
   - `/api/search` - запуск полного многоэтапного процесса
   - `/api/progress/{id}` - получение прогресса по всем стадиям
   - `/api/stop/{id}` - остановка процесса на текущей стадии

4. **Обновление интерфейса**:
   - Показ текущей стадии и общего прогресса
   - Детальная информация по каждой стадии
   - Кнопка остановки процесса

### Порядок реализации

1. **Этап 1: Базовая инфраструктура**
   - Создание типов для многоэтапного процесса
   - Расширение `ProcessingStage` enum
   - Добавление полей прогресса в `CollectionProgress`

2. **Этап 2: Filtering Service**
   - Реализация `FilteringService` с логикой фильтрации
   - Интеграция с настройками пользователя
   - Добавление статусов фильтрации в базу данных

3. **Этап 3: Enrichment Service**
   - Реализация `EnrichmentService` для LLM обработки
   - Интеграция с OpenAI API
   - Добавление полей обогащения в базу данных

4. **Этап 4: Multi-Stage Orchestrator**
   - Создание `MultiStageSearchOrchestrator`
   - Последовательное выполнение стадий
   - Управление состоянием процесса

5. **Этап 5: API и интерфейс**
   - Обновление REST API для многоэтапного процесса
   - Расширение веб-интерфейса для показа стадий
   - Реализация кнопки остановки

6. **Этап 6: Тестирование и документация**
   - Unit тесты для новых сервисов
   - Integration тесты для полного процесса
   - Обновление SDS и SRS документации

## Consequences (Последствия)
### Положительные эффекты:
- Полная реализация заявленной функциональности FR-2
- Масштабируемая архитектура для будущих стадий
- Лучший UX с прозрачным прогрессом
- Возможность остановки долгих операций

### Отрицательные эффекты:
- Увеличение сложности кода
- Дополнительные зависимости между компонентами
- Более сложное тестирование

### Риски:
- Возможные проблемы с памятью при больших объемах данных
- Сложность отладки многоэтапного процесса
- Потенциальные проблемы с конкурентностью

## Implementation Plan (План реализации)

### Шаг 1: Базовая инфраструктура (1-2 дня)
- [ ] Расширить типы для многоэтапного процесса
- [ ] Добавить поля прогресса в `CollectionProgress`
- [ ] Создать базовый `MultiStageSearchOrchestrator`

### Шаг 2: Filtering Service (2-3 дня)
- [ ] Реализовать `FilteringService`
- [ ] Добавить логику фильтрации по настройкам
- [ ] Интегрировать с базой данных

### Шаг 3: Enrichment Service (3-4 дня)
- [ ] Реализовать `EnrichmentService`
- [ ] Интегрировать с OpenAI API
- [ ] Добавить обработку ошибок

### Шаг 4: Orchestrator Integration (2-3 дня)
- [ ] Интегрировать все сервисы в оркестратор
- [ ] Реализовать последовательное выполнение стадий
- [ ] Добавить обработку остановки

### Шаг 5: UI/UX Updates (2-3 дня)
- [ ] Обновить веб-интерфейс для показа стадий
- [ ] Реализовать клиентскую логику прогресса
- [ ] Добавить кнопку остановки

### Шаг 6: Testing & Documentation (2-3 дня)
- [ ] Написать unit тесты
- [ ] Провести integration тестирование
- [ ] Обновить документацию

## Implementation Status ✅ COMPLETED

### ✅ Шаг 1: Базовая инфраструктура - ЗАВЕРШЕН (1 день)
- [x] ✅ Расширить типы для многоэтапного процесса (`MultiStageProgress`, `StageProgress`)
- [x] ✅ Добавить поля прогресса в `CollectionProgress`
- [x] ✅ Создать базовый `MultiStageSearchOrchestrator`

### ✅ Шаг 2: Filtering Service - ЗАВЕРШЕН (2 дня)
- [x] ✅ Реализовать `FilteringService` с логикой фильтрации
- [x] ✅ Добавить логику фильтрации по настройкам пользователя
- [x] ✅ Интегрировать с базой данных
- [x] ✅ Создать unit тесты для `FilteringService`

### ✅ Шаг 3: Enrichment Service - ЗАВЕРШЕН (3 дня)
- [x] ✅ Реализовать `EnrichmentService` для LLM обработки
- [x] ✅ Интегрировать с OpenAI API
- [x] ✅ Добавить обработку ошибок
- [x] ✅ Создать unit тесты для `EnrichmentService`

### ✅ Шаг 4: Orchestrator Integration - ЗАВЕРШЕН (2 дня)
- [x] ✅ Интегрировать все сервисы в оркестратор
- [x] ✅ Реализовать последовательное выполнение стадий
- [x] ✅ Добавить обработку остановки
- [x] ✅ Создать unit тесты для `MultiStageSearchOrchestrator`

### ✅ Шаг 5: API и интерфейс - ЗАВЕРШЕН (2 дня)
- [x] ✅ Обновить веб-интерфейс для показа стадий
- [x] ✅ Реализовать клиентскую логику прогресса
- [x] ✅ Добавить кнопку остановки
- [x] ✅ Обновить REST API для многоэтапного процесса

### ✅ Шаг 6: Тестирование и документация - ЗАВЕРШЕН (1 день)
- [x] ✅ Написать unit тесты для всех новых компонентов
- [x] ✅ Провести integration тестирование
- [x] ✅ Обновить документацию

**Фактическое время выполнения**: 11 дней (опережающий график)

### Критерии готовности - ВСЕ ВЫПОЛНЕНЫ ✅
- [x] ✅ **FR-2.1**: Запуск многоэтапного процесса поиска
- [x] ✅ **FR-2.2**: Отображение текущего этапа и реального прогресса
- [x] ✅ **FR-2.3**: Возможность остановки поиска на любом этапе
- [x] ✅ **FR-2.4**: Сохранение результатов при остановке
- [x] ✅ **FR-2.5**: Отображение финальной статистики по завершении
- [x] ✅ **Тесты**: Прохождение всех unit и integration тестов
- [x] ✅ **Документация**: Обновление технической документации
